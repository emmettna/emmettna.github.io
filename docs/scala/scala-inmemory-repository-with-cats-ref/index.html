<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Scala InMemory Repository with Cats Ref · Data and Programming</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="1. Not enough time to implement Real persistent storage."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Scala InMemory Repository with Cats Ref · Data and Programming"/><meta property="og:type" content="website"/><meta property="og:url" content="https://emmettna.github.io/"/><meta property="og:description" content="1. Not enough time to implement Real persistent storage."/><meta property="og:image" content="https://emmettna.github.io/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://emmettna.github.io/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/dev_logo.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-35663966-2', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/dev_logo_transparant.png" alt="Data and Programming"/><h2 class="headerTitleWithLogo">Data and Programming</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/architecture/cqrs" target="_self">Programming</a></li><li class=""><a href="/docs/deeplearning/deeplearning" target="_self">Data Science</a></li><li class=""><a href="/docs/book/objective" target="_self">Book</a></li><li class=""><a href="/about" target="_self">About</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Scala</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Programming<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Arechitecture &amp; Design</h4><ul><li class="navListItem"><a class="navItem" href="/docs/architecture/cqrs">CQRS</a></li><li class="navListItem"><a class="navItem" href="/docs/architecture/crud-vs-eventsourcing">Crud vs EventSourcing</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Scala</h4><ul><li class="navListItem"><a class="navItem" href="/docs/scala/fastest-way-to-write-DB(postgres)-with-scala">Fastest way to write DB(postgres)</a></li><li class="navListItem"><a class="navItem" href="/docs/scala/fastest-way-of-write-Http4s-server">Fastest way of write Http4s server</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/scala/scala-inmemory-repository-with-cats-ref">InMemory Repository with Cats Ref</a></li><li class="navListItem"><a class="navItem" href="/docs/scala/inmemory-event-sourcing-in-scala">WIP:inmemory-event-sourcing-in-scala</a></li><li class="navListItem"><a class="navItem" href="/docs/scala/scala-pattern-matching">Pattern matching</a></li><li class="navListItem"><a class="navItem" href="/docs/scala/tuple-type-alias-and-case-class">Tuple, Type Alias and Case Class</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Functional</h4><ul><li class="navListItem"><a class="navItem" href="/docs/functional/covariant-contravariant">WIP:Covariant vs Contravariant</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Experience<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/experience/courage-to-say-you-don&#x27;t-know">Courage to say you don&#x27;t know</a></li><li class="navListItem"><a class="navItem" href="/docs/experience/how-to-communicate-with-non-developer">Communicate with Non-Devs</a></li><li class="navListItem"><a class="navItem" href="/docs/experience/reasons-why-i-like-static-types">Reasons why I like static types</a></li><li class="navListItem"><a class="navItem" href="/docs/experience/things-i-didn&#x27;t-know-back-then">Things I didn&#x27;t know back then</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Scala InMemory Repository with Cats Ref</h1></header><article><div><span><ol>
<li>Not enough time to implement Real persistent storage.</li>
<li>But stub is too limited option for various cases.</li>
<li>When my boss tells me to do it (Duh!)</li>
</ol>
<p>That's when I use InMemory storage. It's pretty handy when you run your test in your local device. It adds up and erase all the data every time you run it. Plus you can set the initial data for the test. Plus Plus easier(should I say faster?) to implement/refactor codes. Which leads to  productivity.</p>
<p>If you are reading this, you already decided to implement InMemory Storage. I guess I don't need to explain the benefits of it(My bad). Let's do some coding then.</p>
<p>Just Right before type codes, One thing I'd like to mention about it concurrency. Which is why I and We are going to use <code>Cats.Ref</code> Well, it's not exactly called <code>Cats.Ref</code> but for the sake of brevity.</p>
<p>Honestly I'm not really good at Cats effect types but let me share at least as much as I know for now. I will abstract Effect type. But it won't matter as long as you use any cats implemented effect types like CatsIO, Zio or what not.</p>
<p>Let's say we have such repository</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Human</span>(<span class="hljs-params">name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span></span>)</span>

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">SimpleCrud</span>[<span class="hljs-type">F</span>[_]] </span>{
  <span class="hljs-keyword">val</span> simpleCrudService: <span class="hljs-type">SimpleCrud</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">F</span>]
}
<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">SimpleCrud</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span>[<span class="hljs-type">F</span>[_]] </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span></span>: <span class="hljs-type">F</span>[<span class="hljs-type">Unit</span>]
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find</span></span>(name: <span class="hljs-type">Name</span>): <span class="hljs-type">F</span>[<span class="hljs-type">Option</span>[<span class="hljs-type">Human</span>]]
  }
}
</code></pre>
<p>Then InMemory storage can be implemented such way</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> cats.<span class="hljs-type">Applicative</span>
<span class="hljs-keyword">import</span> cats.effect.concurrent.<span class="hljs-type">Ref</span>
<span class="hljs-keyword">import</span> cats.implicits._
<span class="hljs-keyword">import</span> cats.effect._

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InMemorySimpleCrud</span>[<span class="hljs-type">F</span>[_]</span>: <span class="hljs-type">Applicative</span>](ref: <span class="hljs-type">Ref</span>[<span class="hljs-type">F</span>, <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Human</span>]])
    <span class="hljs-keyword">extends</span> <span class="hljs-type">SimpleCrud</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">F</span>] {

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span></span>(human: <span class="hljs-type">Human</span>): <span class="hljs-type">F</span>[<span class="hljs-type">Unit</span>] =
    ref.update(_.updated(human.name, human))

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find</span></span>(name: <span class="hljs-type">String</span>): <span class="hljs-type">F</span>[<span class="hljs-type">Option</span>[<span class="hljs-type">Human</span>]] =
    ref.get.map_.get(name)
}
<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">InMemorySimpleCrud</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span></span>[<span class="hljs-type">F</span>[_]: <span class="hljs-type">Applicative</span>](<span class="hljs-keyword">implicit</span> <span class="hljs-type">FF</span>: <span class="hljs-type">Sync</span>[<span class="hljs-type">F</span>]): <span class="hljs-type">InMemorySimpleCrud</span>[<span class="hljs-type">F</span>] =
    <span class="hljs-keyword">new</span> <span class="hljs-type">InMemorySimpleCrud</span>[<span class="hljs-type">F</span>](<span class="hljs-type">Ref</span>.unsafe[<span class="hljs-type">F</span>, <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Human</span>]](<span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">OrderHistory</span>]().empty))
}

</code></pre>
<p>It ain't so bad huh?</p>
<p>I skipped one flatMap in order to make the code more shorter and clean. I wouldn't recommend using Ref.unsafe unless it's a toy project. Only difference is F[Ref[F, _]] and Ref[F, _]. Just the outer Effect type</p>
<p>You just need to use flatMap in real case in order to unwrap when you apply initiate InMemory. (feel free to leave a comment below if you still don't understand)</p>
<p>I also set the initial state as empty. But you can always set the initial state with something else as long as you know java Map, it won't be too difficult to swap it with your own.</p>
<p>It's pretty simple coding if you how things work in Scala and cats. But if you are only familiar with sequential programming, this simple coding is also challenging task. So no need to feel bad if you don't know it nor feel greater if you reckon this is way too simple. We all had the time when we just started.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/scala/fastest-way-of-write-Http4s-server"><span class="arrow-prev">← </span><span>Fastest way of write Http4s server</span></a><a class="docs-next button" href="/docs/scala/inmemory-event-sourcing-in-scala"><span>WIP:inmemory-event-sourcing-in-scala</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a></a><div></div><div><h5>Social Media</h5><a href="https://www.linkedin.com/in/emmett-sangkyun-na-10236012b/">LinkedIn</a><a href="https://github.com/emmettna">GitHub</a></div><div></div></section><section class="copyright">Copyright © 2021 Emmett Na</section></footer></div></body></html>